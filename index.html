<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AFMAP - المؤسسة الجزائرية للنباتات الطبية</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #2e7d32;
            --secondary: #81c784;
            --accent: #ffb74d;
            --dark: #1b5e20;
            --bg: #f8fcf8;
            --sidebar-width: 280px;
            --dashboard-bg: #f4f7fa;
            --glass: rgba(255, 255, 255, 0.95);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; outline: none; }
        body { background-color: var(--bg); overflow-x: hidden; scroll-behavior: smooth; transition: 0.3s; }
        
        /* --- Preloader --- */
        #preloader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            flex-direction: column; transition: opacity 0.5s ease;
        }
        .loader-spinner {
            width: 50px; height: 50px; border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Animations --- */
        .fade-in { animation: fadeIn 0.8s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        @keyframes glowing {
            0% { box-shadow: 0 0 5px var(--accent); }
            50% { box-shadow: 0 0 20px var(--accent), 0 0 10px #ffd54f; }
            100% { box-shadow: 0 0 5px var(--accent); }
        }
        .event-glow {
            animation: glowing 2s infinite;
            border: 2px solid var(--accent) !important;
            background: rgba(0,0,0,0.6);
            cursor: pointer;
        }

        /* --- Language Toggle --- */
        .lang-btn {
            position: fixed; bottom: 20px; left: 20px; z-index: 1005;
            background: var(--dark); color: white; padding: 10px 15px;
            border-radius: 50px; cursor: pointer; border: 2px solid white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); font-weight: bold; transition: 0.3s;
        }
        .lang-btn:hover { transform: scale(1.1); }

        /* --- Header --- */
        header {
            background: var(--glass); padding: 10px 20px; position: sticky; top: 0; z-index: 1000;
            display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            backdrop-filter: blur(10px);
        }
        .logo-container { display: flex; align-items: center; gap: 10px; }
        .logo-container img { height: 50px; }
        .menu-btn { font-size: 1.5rem; color: var(--primary); cursor: pointer; border: none; background: none; }

        /* --- Sidebar --- */
        .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1001; display: none; }
        .side-menu {
            position: fixed; top: 0; width: var(--sidebar-width); height: 100%;
            background: white; z-index: 1002; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); padding: 20px;
            display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.2);
        }
        html[dir="rtl"] .side-menu { right: -300px; border-left: 5px solid var(--primary); }
        html[dir="rtl"] .side-menu.active { right: 0; }
        html[dir="ltr"] .side-menu { left: -300px; border-right: 5px solid var(--primary); }
        html[dir="ltr"] .side-menu.active { left: 0; }

        .side-link {
            padding: 15px; border-bottom: 1px solid #eee; text-decoration: none;
            color: #333; font-weight: bold; display: flex; align-items: center; gap: 10px; transition: 0.3s;
        }
        .side-link:hover { background: #e8f5e9; color: var(--primary); padding-inline-start: 20px; }

        /* --- Hero --- */
        .hero {
            height: 85vh; position: relative; display: flex; align-items: center; justify-content: center;
            text-align: center; color: white; background-size: cover; background-position: center;
            transition: background-image 1s ease-in-out;
        }
        .hero::before { content: ''; position: absolute; inset: 0; background: rgba(0,0,0,0.5); }
        .hero-content { position: relative; z-index: 2; padding: 20px; width: 100%; max-width: 800px; }
        .hero h1 { font-size: 3rem; margin-bottom: 15px; text-shadow: 0 4px 15px rgba(0,0,0,0.7); }
        
        .event-wrapper { margin-bottom: 25px; display: inline-flex; flex-wrap: wrap; justify-content: center; gap: 15px; align-items: center; }
        .event-badge { 
            color: white; padding: 10px 25px; border-radius: 50px; 
            font-weight: 900; letter-spacing: 1px; font-size: 1rem;
        }
        
        /* --- Stats --- */
        .stats-bar { 
            background: var(--primary); padding: 40px 5%; color: white; margin-top: -50px; position: relative; z-index: 10;
            border-radius: 30px 30px 0 0; display: flex; flex-wrap: wrap; justify-content: space-around; gap: 30px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
        }
        .stat-item { text-align: center; min-width: 120px; }
        .stat-item i { font-size: 2.5rem; margin-bottom: 10px; color: var(--accent); }
        .stat-num { font-size: 2rem; font-weight: 900; display: block; }

        /* --- Grid --- */
        .section-container { padding: 60px 5%; }
        .section-title { text-align: center; margin-bottom: 50px; color: var(--dark); font-size: 2.2rem; position: relative; }
        .section-title::after { content: ''; display: block; width: 80px; height: 4px; background: var(--accent); margin: 15px auto; border-radius: 2px; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; }
        .founders-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 25px; }
        @media (max-width: 500px) { .founders-grid { grid-template-columns: 1fr; } }

        /* --- Cards --- */
        .card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: 0.4s; height: 100%; display: flex; flex-direction: column; }
        .card:hover { transform: translateY(-8px); box-shadow: 0 15px 30px rgba(0,0,0,0.15); }
        .card-img { width: 100%; height: 200px; object-fit: cover; }
        .card-body { padding: 20px; flex: 1; display: flex; flex-direction: column; }
        .card h3 { color: var(--primary); font-size: 1.2rem; margin-bottom: 10px; }
        .card p { color: #666; line-height: 1.6; font-size: 0.95rem; flex: 1; }
        .card-btn { 
            background: var(--secondary); color: white; padding: 8px 15px; 
            border-radius: 4px; text-decoration: none; font-size: 0.9rem; 
            margin-top: 15px; text-align: center; display: inline-block; cursor: pointer;
        }
        .card-btn:hover { background: var(--primary); }

        /* --- Footer --- */
        footer { background: #1a1a1a; color: #ccc; padding: 50px 20px; text-align: center; margin-top: 50px; border-top: 5px solid var(--accent); }
        .footer-links { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-bottom: 20px; }
        .footer-links a { color: #fff; text-decoration: none; font-weight: bold; transition: 0.3s; border-bottom: 1px solid transparent; }
        .footer-links a:hover { color: var(--accent); border-bottom-color: var(--accent); }

        /* --- Admin & Modals --- */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; display: none; justify-content: center; align-items: center; padding: 20px; backdrop-filter: blur(5px); }
        .privacy-content { background: white; width: 100%; max-width: 600px; padding: 30px; border-radius: 10px; max-height: 80vh; overflow-y: auto; text-align: start; }
        .dashboard-container { 
            background: var(--dashboard-bg); width: 95vw; height: 95vh; border-radius: 15px; overflow: hidden; display: flex; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .dash-sidebar { width: 250px; background: #2c3e50; color: white; display: flex; flex-direction: column; padding: 20px 0; }
        .dash-sidebar h3 { text-align: center; margin-bottom: 30px; color: var(--accent); border-bottom: 1px solid #34495e; padding-bottom: 20px; }
        .dash-nav-btn { padding: 15px 25px; border: none; background: none; color: #ecf0f1; text-align: start; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 10px; font-size: 1rem; }
        .dash-nav-btn:hover, .dash-nav-btn.active { background: var(--primary); color: white; border-left: 5px solid var(--accent); }
        .dash-content { flex: 1; padding: 30px; overflow-y: auto; }
        
        .dash-stats-row { display: flex; gap: 20px; margin-bottom: 30px; }
        .dash-stat-card { flex: 1; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; }
        .dash-stat-num { font-size: 2rem; font-weight: bold; color: var(--dark); }
        
        .admin-form-group { margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e0e0e0; }
        .admin-input { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; transition: 0.3s; }
        .btn-primary { background: var(--primary); }
        .btn-danger { background: #e74c3c; }
        .btn-success { background: #27ae60; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <!-- PRELOADER -->
    <div id="preloader">
        <div class="loader-spinner"></div>
        <h3 style="margin-top:20px; color:var(--primary);">AFMAP</h3>
    </div>

    <!-- Language Toggle -->
    <button class="lang-btn" onclick="toggleLanguage()">
        <i class="fas fa-globe"></i> <span id="lang-text">Français</span>
    </button>

    <!-- Header -->
    <header>
        <div class="logo-container">
             <div style="font-size:2rem; color:var(--primary);"><i class="fas fa-leaf"></i></div>
             <div>
                 <h2 style="color: var(--primary); line-height:1;">AFMAP</h2>
                 <small style="font-size:0.7rem; color:#666;" data-key="header_subtitle">Medicinal Plants</small>
             </div>
        </div>
        <button class="menu-btn" onclick="toggleMenu()"><i class="fas fa-bars"></i></button>
    </header>

    <!-- Sidebar -->
    <div class="sidebar-overlay" onclick="toggleMenu()" id="overlay"></div>
    <div class="side-menu" id="side-menu">
        <div style="text-align: end; margin-bottom: 20px;"><i class="fas fa-times close-menu" onclick="toggleMenu()" style="cursor:pointer; font-size:1.5rem;"></i></div>
        <a href="#hero" class="side-link" onclick="toggleMenu()"><i class="fas fa-home"></i> <span data-key="nav_home">الرئيسية</span></a>
        <a href="#services" class="side-link" onclick="toggleMenu()"><i class="fas fa-hand-holding-heart"></i> <span data-key="nav_services">الخدمات</span></a>
        <a href="#products" class="side-link" onclick="toggleMenu()"><i class="fas fa-leaf"></i> <span data-key="nav_products">المنتجات</span></a>
        <a href="#blog" class="side-link" onclick="toggleMenu()"><i class="fas fa-newspaper"></i> <span data-key="nav_blog">المدونة</span></a>
        <a href="#founders" class="side-link" onclick="toggleMenu()"><i class="fas fa-users"></i> <span data-key="nav_founders">المؤسسين</span></a>
        <a href="#contact" class="side-link" onclick="toggleMenu()"><i class="fas fa-envelope"></i> <span data-key="nav_contact">اتصل بنا</span></a>
        <a href="#" class="side-link" onclick="openLoginModal()" style="margin-top:auto; background:var(--dark); color:white; justify-content:center; border-radius:8px;"><i class="fas fa-lock"></i> Admin</a>
    </div>

    <!-- Hero -->
    <section class="hero" id="hero">
        <div class="hero-content fade-in">
            <div class="event-wrapper">
                <div class="event-badge event-glow" id="hero-event-text"></div>
            </div>
            <h1 id="hero-title"></h1>
            <p id="hero-desc" style="font-size: 1.3rem; margin-bottom:20px;"></p>
        </div>
    </section>

    <!-- Stats -->
    <div class="stats-bar" id="stats-display"></div>

    <!-- Services -->
    <section class="section-container" style="background: white;" id="services">
        <h2 class="section-title" data-key="sec_services">خدماتنا</h2>
        <div class="grid" id="services-grid"></div>
    </section>

    <!-- Products -->
    <section class="section-container" id="products">
        <h2 class="section-title" data-key="sec_products">منتجاتنا</h2>
        <div class="grid" id="products-grid"></div>
    </section>

    <!-- Blog -->
    <section class="section-container" style="background: white;" id="blog">
        <h2 class="section-title" data-key="sec_blog">المدونة</h2>
        <div class="grid" id="blog-grid"></div>
    </section>

    <!-- Founders -->
    <section class="section-container" id="founders">
        <h2 class="section-title" data-key="sec_founders">المؤسسين</h2>
        <div class="founders-grid" id="founders-grid"></div>
    </section>

    <!-- Contact & Location -->
    <section class="section-container" style="background: #2e7d32; color: white;" id="contact">
        <h2 class="section-title" style="color: white; border-color: white;" data-key="sec_contact">اتصل بنا</h2>
        <div style="text-align: center; font-size:1.2rem;">
            <p><i class="fas fa-phone"></i> <span id="contact-phone"></span></p>
            <p style="margin-top:10px;"><i class="fas fa-envelope"></i> <span id="contact-email"></span></p>
            <p style="margin-top:10px;"><i class="fas fa-map-marker-alt"></i> الجزائر، العاصمة (Rouiba)</p>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="footer-links">
            <a href="#about" data-key="ft_about">من نحن</a>
            <a href="#" onclick="document.getElementById('privacy-modal').style.display='flex'" data-key="ft_privacy">سياسة الخصوصية</a>
            <a href="#contact" data-key="ft_location">موقعنا</a>
        </div>
        <p>AFMAP &copy; 2026. All Rights Reserved.</p>
    </footer>

    <!-- ================== MODALS ================== -->

    <div class="modal" id="privacy-modal">
        <div class="privacy-content">
            <h2 style="color:var(--primary); margin-bottom:20px;">سياسة الخصوصية</h2>
            <p>نحن في المؤسسة الجزائرية للنباتات الطبية (AFMAP) نلتزم بحماية خصوصية زوارنا.</p>
            <button class="btn btn-primary" onclick="document.getElementById('privacy-modal').style.display='none'">إغلاق</button>
        </div>
    </div>

    <div class="modal" id="login-modal">
        <div style="background:white; padding:30px; border-radius:10px; text-align:center; width:300px;">
            <h3 style="margin-bottom:15px; color:var(--primary);">Admin Login</h3>
            <input type="password" id="admin-pass" class="admin-input" placeholder="Password" style="margin-bottom:15px;">
            <button class="btn btn-primary" style="width:100%" onclick="checkLogin()">Login</button>
            <button class="btn" style="width:100%; margin-top:5px; color:#666;" onclick="document.getElementById('login-modal').style.display='none'">Cancel</button>
        </div>
    </div>

    <div class="modal" id="dashboard-modal">
        <div class="dashboard-container">
            <div class="dash-sidebar">
                <h3>AFMAP <span>CMS</span></h3>
                <button class="dash-nav-btn active" onclick="switchTab('home')"><i class="fas fa-home"></i> نظرة عامة</button>
                <button class="dash-nav-btn" onclick="switchTab('hero')"><i class="fas fa-image"></i> الواجهة & الخلفيات</button>
                <button class="dash-nav-btn" onclick="switchTab('stats')"><i class="fas fa-chart-bar"></i> شريط الأرقام</button>
                <button class="dash-nav-btn" onclick="switchTab('services')"><i class="fas fa-hand-holding-heart"></i> الخدمات</button>
                <button class="dash-nav-btn" onclick="switchTab('products')"><i class="fas fa-leaf"></i> المنتجات</button>
                <button class="dash-nav-btn" onclick="switchTab('blog')"><i class="fas fa-newspaper"></i> المدونة</button>
                <button class="dash-nav-btn" onclick="switchTab('founders')"><i class="fas fa-users"></i> المؤسسين</button>
                <div style="margin-top:auto; padding:0 20px;">
                    <button class="btn btn-danger" style="width:100%" onclick="location.reload()">تسجيل الخروج</button>
                </div>
            </div>
            <div class="dash-content" id="dash-content"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-analytics.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, getDocs, addDoc, deleteDoc, increment } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAaXp-gUOQ_G2s-kM8JhaqW8TJcJ4Nqcuo",
            authDomain: "comondi-fae4b.firebaseapp.com",
            projectId: "comondi-fae4b",
            storageBucket: "comondi-fae4b.firebasestorage.app",
            messagingSenderId: "932777870241",
            appId: "1:932777870241:web:78b0cf3a3cf14046be01e0",
            measurementId: "G-M09RX0V18S"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        // --- GLOBAL VARIABLES ---
        window.currentLang = 'ar';
        window.siteSettings = {}; 

        const translations = {
            ar: {
                nav_home: "الرئيسية", nav_services: "الخدمات", nav_products: "المنتجات", nav_blog: "المدونة", nav_founders: "المؤسسين", nav_contact: "اتصل بنا",
                sec_services: "خدماتنا", sec_products: "منتجاتنا", sec_blog: "المدونة", sec_founders: "المؤسسين", sec_contact: "اتصل بنا",
                header_subtitle: "المؤسسة الجزائرية للنباتات الطبية",
                ft_about: "من نحن", ft_privacy: "سياسة الخصوصية", ft_location: "موقعنا",
                btn_readmore: "اقرأ المزيد", btn_link: "رابط خارجي"
            },
            fr: {
                nav_home: "Accueil", nav_services: "Services", nav_products: "Produits", nav_blog: "Blog", nav_founders: "Fondateurs", nav_contact: "Contact",
                sec_services: "Nos Services", sec_products: "Nos Produits", sec_blog: "Notre Blog", sec_founders: "Fondateurs", sec_contact: "Contactez-nous",
                header_subtitle: "Fondation Algérienne des Plantes Médicinales",
                ft_about: "Qui sommes-nous", ft_privacy: "Politique de Confidentialité", ft_location: "Localisation",
                btn_readmore: "Lire la suite", btn_link: "Lien externe"
            }
        };

        // --- CACHE & LOAD SYSTEM ---
        
        // 1. Try to load from LocalStorage FIRST (Instant)
        function loadFromCache() {
            const cachedSettings = localStorage.getItem('afmap_settings');
            if (cachedSettings) {
                const data = JSON.parse(cachedSettings);
                window.siteSettings = data;
                renderHero(data);
                renderContact(data);
                window.heroImages = data.heroImages || [];
                startSlider();
            }

            ['stats', 'services', 'products', 'blog', 'founders'].forEach(col => {
                const cachedCol = localStorage.getItem('afmap_' + col);
                if (cachedCol) renderListUI(col, JSON.parse(cachedCol));
            });
        }

        // 2. Fetch from Firebase (Async) & Update Cache
        async function fetchFreshData() {
            trackVisit();
            
            // Settings
            try {
                const settingsSnap = await getDoc(doc(db, "site_content", "settings"));
                if (settingsSnap.exists()) {
                    const data = settingsSnap.data();
                    localStorage.setItem('afmap_settings', JSON.stringify(data)); // Save Cache
                    window.siteSettings = data;
                    renderHero(data);
                    renderContact(data);
                    window.heroImages = data.heroImages || [];
                    startSlider();
                }
            } catch (error) { console.error(error); }

            // Collections
            ['stats', 'services', 'products', 'blog', 'founders'].forEach(async col => {
                const q = await getDocs(collection(db, col));
                let items = [];
                q.forEach(doc => items.push(doc.data()));
                localStorage.setItem('afmap_' + col, JSON.stringify(items)); // Save Cache
                renderListUI(col, items);
            });

            // Hide Preloader once fresh data is checked
            setTimeout(() => {
                const pre = document.getElementById('preloader');
                if(pre) { pre.style.opacity = '0'; setTimeout(()=>pre.remove(), 500); }
            }, 1000);
        }

        // --- RENDER LOGIC ---

        function renderHero(data) {
            document.getElementById('hero-title').innerText = data.heroTitle || "";
            document.getElementById('hero-desc').innerText = data.heroDesc || "";
            const eventText = window.currentLang === 'ar' ? (data.eventTextAr || data.eventText) : (data.eventTextFr || data.eventText);
            document.getElementById('hero-event-text').innerText = eventText || "";
        }

        function renderContact(data) {
            document.getElementById('contact-phone').innerText = data.phone || "";
            document.getElementById('contact-email').innerText = data.email || "";
        }

        function renderListUI(colName, items) {
            const container = document.getElementById(colName + (colName === 'stats' ? '-display' : '-grid'));
            if (!container) return;
            container.innerHTML = '';
            
            items.forEach(item => {
                const btnText = window.currentLang === 'ar' ? translations.ar.btn_readmore : translations.fr.btn_readmore;
                
                if (colName === 'stats') {
                    container.innerHTML += `
                        <div class="stat-item fade-in">
                            <i class="fas ${item.icon}"></i>
                            <span class="stat-num">${item.num}</span>
                            <span>${item.text}</span>
                        </div>`;
                } else if (colName === 'founders') {
                    container.innerHTML += `
                        <div class="card fade-in" style="align-items:center; text-align:center;">
                            <img src="${item.img || 'https://via.placeholder.com/150'}" style="width:120px; height:120px; border-radius:50%; margin-top:20px; border:3px solid var(--primary); object-fit: cover;">
                            <div class="card-body">
                                <h3>${item.name}</h3>
                                <div style="color:var(--primary); font-weight:bold;">${item.role}</div>
                                <p>${item.desc || ''}</p>
                            </div>
                        </div>`;
                } else {
                    container.innerHTML += `
                        <div class="card fade-in">
                            <img src="${item.img || 'https://via.placeholder.com/300'}" class="card-img">
                            <div class="card-body">
                                <h3>${item.title}</h3>
                                <p>${item.desc}</p>
                                ${item.link ? `<a href="${item.link}" target="_blank" class="card-btn">${item.linkText || btnText} <i class="fas fa-external-link-alt"></i></a>` : ''}
                            </div>
                        </div>`;
                }
            });
        }

        function startSlider() {
            if(!window.heroImages || window.heroImages.length === 0) return;
            let idx = 0;
            const heroEl = document.getElementById('hero');
            heroEl.style.backgroundImage = `url('${window.heroImages[0]}')`;
            if(window.heroImages.length > 1) {
                if(window.sliderInt) clearInterval(window.sliderInt);
                window.sliderInt = setInterval(() => {
                    idx = (idx + 1) % window.heroImages.length;
                    heroEl.style.backgroundImage = `url('${window.heroImages[idx]}')`;
                }, 3000);
            }
        }

        async function trackVisit() {
            const today = new Date().toLocaleDateString();
            if (localStorage.getItem('last_visit') !== today) {
                const statsRef = doc(db, "analytics", "visitors");
                try { await updateDoc(statsRef, { daily: increment(1), monthly: increment(1) }); } 
                catch (err) { await setDoc(statsRef, { daily: 1, monthly: 1 }); }
                localStorage.setItem('last_visit', today);
            }
        }

        // --- ADMIN FUNCTIONS ---
        window.checkLogin = function() {
            if (document.getElementById('admin-pass').value === "abobob123") {
                document.getElementById('login-modal').style.display = 'none';
                document.getElementById('dashboard-modal').style.display = 'flex';
                switchTab('home');
            } else { alert("Wrong Password"); }
        }

        window.switchTab = async function(tab) {
            document.querySelectorAll('.dash-nav-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            const content = document.getElementById('dash-content');
            content.innerHTML = '<div style="text-align:center; padding:50px;"><i class="fas fa-spinner fa-spin fa-3x"></i></div>';

            if (tab === 'home') {
                let visits = { daily:0, monthly:0 };
                try { const snap = await getDoc(doc(db, "analytics", "visitors")); if(snap.exists()) visits = snap.data(); } catch(e){}
                content.innerHTML = `
                    <h2>لوحة التحكم / نظرة عامة</h2>
                    <div class="dash-stats-row">
                        <div class="dash-stat-card"><div><div class="dash-stat-num">${visits.daily}</div><div>زيارات اليوم</div></div><i class="fas fa-users dash-stat-icon"></i></div>
                        <div class="dash-stat-card"><div><div class="dash-stat-num">${visits.monthly}</div><div>زيارات الشهر</div></div><i class="fas fa-calendar-alt dash-stat-icon"></i></div>
                    </div>`;
            } else if (tab === 'hero') {
                const snap = await getDoc(doc(db, "site_content", "settings"));
                const data = snap.exists() ? snap.data() : {};
                
                content.innerHTML = `
                    <h2>تعديل الواجهة</h2>
                    <div class="admin-form-group">
                        <label>العنوان الرئيسي</label><input id="in-hero-title" class="admin-input" value="${data.heroTitle || ''}">
                        <label>الوصف</label><input id="in-hero-desc" class="admin-input" value="${data.heroDesc || ''}">
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <div style="flex:1"><label>نص الحدث (عربي)</label><input id="in-event-ar" class="admin-input" value="${data.eventTextAr || ''}" placeholder="حدث قادم..."></div>
                            <div style="flex:1"><label>نص الحدث (فرنسي)</label><input id="in-event-fr" class="admin-input" value="${data.eventTextFr || ''}" placeholder="Prochain événement..."></div>
                        </div>
                        <label>الهاتف</label><input id="in-phone" class="admin-input" value="${data.phone || ''}">
                        <label>الايميل</label><input id="in-email" class="admin-input" value="${data.email || ''}">
                        <button class="btn btn-primary" style="margin-top:10px;" onclick="saveSettings()">حفظ التغييرات</button>
                    </div>
                    <div class="admin-form-group">
                        <label>إضافة صورة خلفية</label>
                        <input type="file" id="hero-file-in" accept="image/*" class="admin-input">
                        <button class="btn btn-success" style="margin-top:5px;" onclick="uploadHeroImage()">رفع الصورة</button>
                    </div>`;
            } else {
                renderAdminList(tab, content);
            }
        }

        window.saveSettings = async function() {
            const newData = {
                heroTitle: document.getElementById('in-hero-title').value,
                heroDesc: document.getElementById('in-hero-desc').value,
                eventTextAr: document.getElementById('in-event-ar').value, 
                eventTextFr: document.getElementById('in-event-fr').value, 
                phone: document.getElementById('in-phone').value,
                email: document.getElementById('in-email').value
            };
            
            await setDoc(doc(db, "site_content", "settings"), newData, { merge: true });
            
            // Update Cache & UI Instantly for Admin
            const current = JSON.parse(localStorage.getItem('afmap_settings')) || {};
            const merged = { ...current, ...newData };
            localStorage.setItem('afmap_settings', JSON.stringify(merged));
            renderHero(merged);
            renderContact(merged);

            alert("تم الحفظ!");
        }

        window.uploadHeroImage = function() {
            const file = document.getElementById('hero-file-in').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async function(e) {
                const snap = await getDoc(doc(db, "site_content", "settings"));
                let imgs = (snap.exists() && snap.data().heroImages) ? snap.data().heroImages : [];
                imgs.push(e.target.result);
                await setDoc(doc(db, "site_content", "settings"), { heroImages: imgs }, { merge: true });
                alert("تم رفع الصورة!");
            };
            reader.readAsDataURL(file);
        }

        async function renderAdminList(colName, container) {
            container.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2>إدارة ${colName}</h2>
                    <button class="btn btn-success" onclick="document.getElementById('add-box').classList.remove('hidden')">+ إضافة جديد</button>
                </div>
                <div id="add-box" class="admin-form-group hidden" style="border:2px solid var(--primary);">
                    <h4>إضافة عنصر جديد</h4>
                    <input id="new-title" class="admin-input" placeholder="العنوان / الاسم">
                    <input id="new-desc" class="admin-input" placeholder="الوصف / المهام">
                    <input id="new-link" class="admin-input" placeholder="رابط تحويل (اختياري - http://...)">
                    <input type="file" id="new-img" class="admin-input" accept="image/*">
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <button class="btn btn-primary" onclick="addItemToFirebase('${colName}')">حفظ ونشر</button>
                        <button class="btn btn-danger" onclick="document.getElementById('add-box').classList.add('hidden')">إلغاء</button>
                    </div>
                </div>
                <div id="admin-list-items" style="margin-top:20px;"></div>`;

            const listContainer = document.getElementById('admin-list-items');
            const q = await getDocs(collection(db, colName));
            q.forEach(docSnap => {
                const d = docSnap.data();
                listContainer.innerHTML += `
                    <div style="background:white; padding:15px; border-radius:8px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                        <div style="display:flex; align-items:center; gap:10px;">
                            ${d.img ? `<img src="${d.img}" style="width:40px; height:40px; border-radius:5px; object-fit:cover;">` : ''}
                            <strong>${d.title || d.name || d.text}</strong>
                        </div>
                        <button class="btn btn-danger" onclick="deleteItem('${colName}', '${docSnap.id}')"><i class="fas fa-trash"></i></button>
                    </div>`;
            });
        }

        window.addItemToFirebase = function(colName) {
            const title = document.getElementById('new-title').value;
            const desc = document.getElementById('new-desc').value;
            const link = document.getElementById('new-link').value;
            const file = document.getElementById('new-img').files[0];
            if(!title) return alert("Required");

            const save = async (imgUrl) => {
                let obj = { title, desc, link, img: imgUrl };
                if (colName === 'stats') obj = { num: title, text: desc, icon: 'fa-star' };
                if (colName === 'founders') obj = { name: title, role: desc, desc: '', img: imgUrl };
                await addDoc(collection(db, colName), obj);
                alert("تمت الإضافة");
                
                // Update Cache Manually to prevent flicker for Admin
                const currentCache = JSON.parse(localStorage.getItem('afmap_'+colName)) || [];
                currentCache.push(obj);
                localStorage.setItem('afmap_'+colName, JSON.stringify(currentCache));
                renderListUI(colName, currentCache);
                
                switchTab(colName);
            };
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => save(e.target.result);
                reader.readAsDataURL(file);
            } else { save(null); }
        }

        window.deleteItem = async function(colName, id) {
            if(confirm("حذف؟")) { await deleteDoc(doc(db, colName, id)); switchTab(colName); }
        }

        window.toggleLanguage = function() {
            window.currentLang = window.currentLang === 'ar' ? 'fr' : 'ar';
            const lang = window.currentLang;
            document.getElementById('lang-text').innerText = lang === 'ar' ? 'Français' : 'العربية';
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            document.querySelectorAll('[data-key]').forEach(el => {
                const key = el.getAttribute('data-key');
                if (translations[lang][key]) el.innerText = translations[lang][key];
            });
            // Re-render UI to update text
            loadFromCache();
        }

        window.toggleMenu = function() {
            document.getElementById('side-menu').classList.toggle('active');
            const overlay = document.getElementById('overlay');
            overlay.style.display = overlay.style.display === 'block' ? 'none' : 'block';
        }
        window.openLoginModal = function() { toggleMenu(); document.getElementById('login-modal').style.display = 'flex'; }
        
        // --- STARTUP SEQUENCE ---
        loadFromCache(); // 1. Render Cache Instant
        fetchFreshData(); // 2. Check Network & Update Cache
    </script>
</body>
</html>
